<div class="close-dialog">
    <button type="button" mat-icon-button [mat-dialog-close]="true">
        <mat-icon>close</mat-icon>
    </button>
</div>

<div class="variavel-upload-container">
    <div class="variaveis-upload-content">
        <fieldset class="variaveis-upload-fieldset">
            <legend>UPLOAD DE VARIÁVEIS</legend>

            <div class="upload-container">
                <div class="upload-actions">
                    <div class="file-action">
                        <input #fileUploadSimple1 class="upload-container-file-input" [accept]="'.csv'" type="file" hidden="true" 
                        (change)="importDataFromCSV1($event)"/>

                        <button mat-flat-button color="accent" (click)="fileUploadSimple1.click()">
                            <mat-icon>file_upload</mat-icon>
                            Importar arquivo CSV
                        </button>

                        <span *ngIf="file1">{{ file1.name }}</span>
                    </div>

                    <div class="save-action">
                        <button mat-flat-button color="primary" [disabled]="data1Status != 'VALID'" (click)="onSaveVariaveis()">
                            Salvar
                        </button>
                    </div>                    
                </div>

                <div class="upload-general-erros">
                    <div *ngIf="data1EmptyFlag">Não há registros no CSV</div>
                    <div *ngIf="data1MissingColumns.length > 0">
                        Colunas obrigatórias ausentes: {{ data1MissingColumns.join(", ") }}
                    </div>
                    <div *ngIf="data1DuplicateVariables">Há variáveis com o mesmo nome</div>
                    <div *ngIf="data1MissingKeyVariable">É obrigatório ao menos uma variável definida como Chave</div>
                </div>
                
                <mat-accordion class="upload-accordion">
                    <mat-expansion-panel>
                        <mat-expansion-panel-header>
                          <mat-panel-title>Variáveis</mat-panel-title>

                          <mat-panel-description>
                            <div class="accordion-none" *ngIf="data1Status == 'NONE'">SEM REGISTROS</div>
                            <div class="accordion-current" *ngIf="data1Status == 'CURRENT'">VARIÁVEIS ATUAIS</div>
                            <div class="accordion-invalid" *ngIf="data1Status == 'INVALID'">INVÁLIDO</div>
                            <div class="accordion-valid" *ngIf="data1Status == 'VALID'">VÁLIDO</div>
                          </mat-panel-description>
                        </mat-expansion-panel-header>

                        <div class="table-container" *ngIf="dataSource1">
                            <table mat-table [dataSource]="dataSource1">        
                                <ng-container matColumnDef="nome">
                                    <th mat-header-cell *matHeaderCellDef [ngStyle]="{'width': '30%' }" class="t-center"> NOME </th>
                                    <td mat-cell *matCellDef="let row" [ngStyle]="{'width': '30%' }" class="t-start">
                                        <div class="validator-group">
                                            <div class="validator-group-value">
                                                <div class="validator-group-value-title">{{ row.variavel.nome }}</div>
                                                <div class="validator-group-value-subtitle">{{ row.variavel.descricao }}</div>
                                            </div>
                                            <div class="validator-group-errors">
                                                <div *ngIf="row.controle.nomeObrigatorio">Nome obrigatório</div>
                                                <div *ngIf="row.controle.nomeInvalido">Nome inválido</div>

                                                <div *ngIf="row.controle.descricaoObrigatorio">Descrição obrigatória</div>
                                                <div *ngIf="row.controle.descricaoEnorme">Descrição maior que o limite permimtido (60 caracteres)</div>
                                            </div>
                                        </div>                                
                                    </td>
                                </ng-container>
                
                                <ng-container matColumnDef="tipo">
                                    <th mat-header-cell *matHeaderCellDef [ngStyle]="{'width': '25%' }" class="t-center"> TIPO </th>
                                    <td mat-cell *matCellDef="let row" [ngStyle]="{'width': '25%' }" class="t-start">
                                        <div class="validator-group">
                                            <div class="validator-group-value">
                                                <span *ngIf="row.variavel.tipo == 'DECIMAL'">Decimal</span>
                                                <span *ngIf="row.variavel.tipo == 'NUMERICO'">Numérico</span>
                                                <span *ngIf="row.variavel.tipo == 'TEXTO'">Texto</span>
                                                <span *ngIf="row.variavel.tipo == 'LISTA'">Lista</span>
                                                <span *ngIf="!['DECIMAL','NUMERICO','TEXTO','LISTA'].includes(row.variavel.tipo)">{{ row.variavel.tipo }}</span>
                                            </div>
                                            <div class="validator-group-errors">
                                                <div *ngIf="row.controle.tipoObrigatorio">Tipo obrigatório</div>
                                                <div *ngIf="row.controle.tipoInexistente">Tipo inválido</div>
                                            </div>
                                        </div>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="chave">
                                    <th mat-header-cell *matHeaderCellDef [ngStyle]="{'width': '15%' }" class="t-center"> CHAVE </th>
                                    <td mat-cell *matCellDef="let row" [ngStyle]="{'width': '15%' }" class="t-start">
                                        <div class="validator-group">
                                            <div class="validator-group-value">
                                                {{ row.variavel.is_chave == true ? "Sim" : (row.variavel.is_chave == false ? "Não" : row.variavel.is_chave) }}
                                            </div>
                                            <div class="validator-group-errors">
                                                <div *ngIf="row.controle.chaveObrigatorio">Chave obrigatória</div>
                                                <div *ngIf="row.controle.chaveNaoBooleano">Chave inválida</div>
                                            </div>
                                        </div>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="tamanho">
                                    <th mat-header-cell *matHeaderCellDef [ngStyle]="{'width': '15%' }" class="t-center"> TAMANHO </th>
                                    <td mat-cell *matCellDef="let row" [ngStyle]="{'width': '15%' }" class="t-start">
                                        <div class="validator-group">
                                            <div class="validator-group-value">
                                                {{ row.variavel.tamanho }}
                                            </div>
                                            <div class="validator-group-errors">
                                                <div *ngIf="row.controle.tamanhoObrigatorio">Tamanho obrigatório</div>
                                                <div *ngIf="row.controle.tamanhoNaoNumerico">Tamanho não numérico</div>
                                                <div *ngIf="row.controle.tamanhoIgualZero">Tamanho inválido</div>
                                            </div>
                                        </div>                                        
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="qtdCasasDecimais">
                                    <th mat-header-cell *matHeaderCellDef [ngStyle]="{'width': '15%' }" class="t-center"> QTD. CASAS DECIMAIS </th>
                                    <td mat-cell *matCellDef="let row" [ngStyle]="{'width': '15%' }" class="t-start">
                                        <div class="validator-group">
                                            <div class="validator-group-value">
                                                {{ row.variavel.tipo == "DECIMAL" ? row.variavel.qtd_casas_decimais : "Não se aplica" }}
                                            </div>
                                            <div class="validator-group-errors">
                                                <div *ngIf="row.controle.qtdCasasDecimaisObrigatorio">Tamanho obrigatório</div>
                                                <div *ngIf="row.controle.qtdCasasDecimaisNaoNumerico">Tamanho não numérico</div>
                                                <div *ngIf="row.controle.qtdCasasDecimaisIgualZero">Tamanho inválido</div>
                                            </div>
                                        </div>                                        
                                    </td>
                                </ng-container>
                
                                <tr mat-header-row *matHeaderRowDef="displayedColumns1"></tr>
                                <tr mat-row *matRowDef="let row; columns: displayedColumns1;"></tr>
                            </table>
                
                            <div class="empty-message" *ngIf="dataSource1.data.length === 0">Nenhuma variável cadastrada.</div>
                        </div>
                    </mat-expansion-panel>
                </mat-accordion>
            </div>
        </fieldset>
    </div>

    <mat-divider></mat-divider>

    <div class="listas-upload-content">
        <fieldset class="listas-upload-fieldset">
            <legend>UPLOAD DE LISTAS</legend>

            <div class="table-container" *ngIf="dataSource2">
                <table mat-table class="mat-elevation-z8" [dataSource]="dataSource2" multiTemplateDataRows>
                    @for (column of displayedColumns2; track column) {
                        <ng-container matColumnDef="{{ column }}">
                            <ng-container *ngIf="column == 'nome'">
                                <th mat-header-cell *matHeaderCellDef [ngStyle]="{'width': '40%' }">Nome</th>
                                <td mat-cell *matCellDef="let element" [ngStyle]="{'width': '40%' }">{{ element.nome }}</td>
                            </ng-container>

                            <ng-container *ngIf="column == 'status'">
                                <th mat-header-cell *matHeaderCellDef [ngStyle]="{'width': '30%' }">Status</th>
                                <td mat-cell *matCellDef="let element" [ngStyle]="{'width': '30%' }" style="padding-top: 8px; padding-bottom: 8px;">
                                    <div class="status-none" *ngIf="element.dataStatus == 'NONE'">SEM REGISTROS</div>
                                    <div class="status-current" *ngIf="element.dataStatus == 'CURRENT'">VARIÁVEIS ATUAIS</div>
                                    <div class="status-invalid" *ngIf="element.dataStatus == 'INVALID'">INVÁLIDO</div>
                                    <div class="status-valid" *ngIf="element.dataStatus == 'VALID'">VÁLIDO</div>

                                    <div class="status-error" *ngIf="element.dataEmptyFlag">Não há registros no CSV</div>
                                    <div class="status-error" *ngIf="element.dataMissingColumns.length > 0">
                                        Colunas obrigatórias ausentes: {{ element.dataMissingColumns.join(", ") }}
                                    </div>
                                </td>
                            </ng-container>

                            <ng-container *ngIf="column == 'file'">
                                <th mat-header-cell *matHeaderCellDef [ngStyle]="{'width': '15%' }">Upload</th>
                                <td mat-cell *matCellDef="let element" [ngStyle]="{'width': '15%' }">
                                    <div class="file-action">
                                        <input #fileUploadSimple class="upload-container-file-input" [accept]="'.csv'" type="file" hidden="true" 
                                            (change)="importDataFromCSV2($event, element)"/>
                
                                        <button mat-flat-button color="accent" (click)="fileUploadSimple.click()">
                                            <mat-icon>file_upload</mat-icon>
                                            Importar arquivo CSV
                                        </button>
                                    </div>
                                </td>
                            </ng-container>

                            <ng-container *ngIf="column == 'action'">
                                <th mat-header-cell *matHeaderCellDef [ngStyle]="{'width': '15%' }">Ação</th>
                                <td mat-cell *matCellDef="let element" [ngStyle]="{'width': '15%' }">
                                    <div class="save-action">
                                        <button mat-flat-button color="primary" [disabled]="element.dataStatus != 'VALID'" (click)="onSaveLista(element)">
                                            Salvar
                                        </button>
                                    </div>
                                </td>
                            </ng-container>
                        </ng-container>
                    }

                    <ng-container matColumnDef="expand">
                        <th mat-header-cell *matHeaderCellDef aria-label="row actions">&nbsp;</th>
                        <td mat-cell *matCellDef="let element">
                            <button mat-icon-button aria-label="expand row" (click)="(expandedElement = expandedElement === element ? null : element); $event.stopPropagation()">
                                @if (expandedElement === element) {
                                    <mat-icon>keyboard_arrow_up</mat-icon>
                                } @else {
                                    <mat-icon>keyboard_arrow_down</mat-icon>
                                }
                            </button>
                        </td>
                    </ng-container>
         
                    <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
                    <ng-container matColumnDef="expandedDetail">
                        <td mat-cell *matCellDef="let element" [attr.colspan]="displayedColumns2Expand.length">
                            <div class="example-element-detail" [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
                                <span class="table-file-name" *ngIf="element.file">{{ element.file.name }}</span>

                                <table class="table-lista">
                                    <thead>
                                        <tr>
                                            <th colspan="3">ITEM</th>
                                            <th colspan="1">VISÍVEL?</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let item of element.data">
                                            <td colspan="3">
                                                <div class="validator-group">
                                                    <div class="validator-group-value">{{ item.lista.nome }}</div>
                                                    <div class="validator-group-errors">
                                                        <div *ngIf="item.controle.nomeObrigatorio">Nome obrigatório</div>
                                                    </div>
                                                </div>
                                            </td>

                                            <td colspan="1">
                                                <div class="validator-group">
                                                    <div class="validator-group-value">
                                                        {{ item.lista.is_visivel == true ? "Sim" : (item.lista.is_visivel == false ? "Não" : item.lista.is_visivel) }}
                                                    </div>
                                                    <div class="validator-group-errors">
                                                        <div *ngIf="item.controle.ativoObrigatorio">Ativo obrigatória</div>
                                                        <div *ngIf="item.controle.ativoNaoBooleano">Ativo inválido</div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </ng-container>
            
                    <tr mat-header-row *matHeaderRowDef="displayedColumns2Expand"></tr>
                    
                    <tr mat-row *matRowDef="let element; columns: displayedColumns2Expand;"
                        class="example-element-row"
                        [class.example-expanded-row]="expandedElement === element"
                        (click)="expandedElement = expandedElement === element ? null : element">
                    </tr>
                    <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>
                </table>

                <div class="empty-message" *ngIf="dataSource2.data.length === 0">Nenhuma lista cadastrada.</div>
            </div>
        </fieldset>
    </div>
</div>